requires = ["tox>=4.0"]
env_list = ["py311", "lint", "type", "precommit", "coverage"]

[env_run_base]
usedevelop = true

deps = [
    # development dependencies
    "pytest>=7.0",
    "pytest-asyncio>=0.21",
    "pytest-cov>=4.0",
    "ruff>=0.1.0",
    "mypy>=1.5",
    "tox>=4.32.0",
    "pre-commit>=3.0",
    "aiofiles>=25.1.0", # async file operations
    "types-aiofiles>=23.0",
    # redis backend
    "redis>=7.0.1",
    # observability
    "opentelemetry-api>=1.27.0",
    "opentelemetry-sdk>=1.27.0",
    "opentelemetry-exporter-otlp-proto-http>=1.27.0"
]

commands_pre = [
    ["python", "-m", "pip", "install", "--upgrade", "pip"],
    ["python", "-m", "pip", "install", "-e", ".[dev]"],
]

setenv = { PYTHONWARNINGS = "default::DeprecationWarning" }
passenv = ["CI", "GITHUB_ACTIONS", "GITHUB_*", "QCRAWL_*"]
skip_install = false

commands = [["pytest", "-q", "--maxfail=1"]]

[env.py311]
description = "Run tests on Python 3.11"
basepython = ["python3.11"]

[env.lint]
description = "Run linters / formatter (ruff)"
basepython = ["python3.11"]
commands = [
    ["ruff", "format", "--exit-non-zero-on-fix", "."],
    ["ruff", "check", "."],
]

[env.type]
description = "Run static typing (mypy)"
basepython = ["python3.11"]
commands = [["mypy", "."]]

[env.precommit]
description = "Run pre-commit hooks"
basepython = ["python3.11"]
commands = [["pre-commit", "run", "--all-files"]]

[env.coverage]
description = "Run tests with coverage report"
basepython = ["python3.11"]
commands = [
    ["pytest",
        "--cov=qcrawl",
        "--cov-report=term-missing",
        "--cov-report=xml",
        "--junitxml=junit.xml",
        "-o", "junit_family=legacy"],
]
